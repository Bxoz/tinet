---
# mirror
# [M1:10](0)-{1}-(0)[R1:1](1)-{2}-(0)[R2:2](1)-{3}-(0)[R3:3]
#
# networkAddress: 10.{N1}.0.N2/24
#   N1: networkLinkID
#   N2: nodeID
nodes:
- name: M1
  #image: slankdev/iproute2:5.8
  image: slankdev/ubuntu:18.04
  interfaces:
  - { name: net0, type: direct, args: R1#net0 }
- name: R1
  # image: slankdev/iproute2:5.8
  image: slankdev/ubuntu:18.04
  interfaces:
  - { name: net0, type: direct, args: M1#net0 }
  - { name: net1, type: direct, args: R2#net0 }
- name: R2
  # image: slankdev/iproute2:5.8
  image: slankdev/ubuntu:18.04
  interfaces:
  interfaces:
  - { name: net0, type: direct, args: R1#net1 }
  - { name: net1, type: direct, args: R3#net0 }
- name: R3
  image: slankdev/iproute2:5.8
  interfaces:
  - { name: net0, type: direct, args: R2#net1 }

node_configs:
- name: M1
  cmds:
  - cmd: ip addr add 10.1.0.10/24 dev net0

  - cmd: ip link add mon0 type vxlan id 100 dstport 5555
  - cmd: ip link set mon0 up

- name: R1
  cmds:
  - cmd: ip addr add 10.1.0.1/24 dev net0
  - cmd: ip addr add 10.2.0.1/24 dev net1
  - cmd: ip route add default via 10.2.0.2

- name: R2
  cmds:
  - cmd: ip addr add 10.2.0.2/24 dev net0
  - cmd: ip addr add 10.3.0.2/24 dev net1
  - cmd: ip route add default via 10.2.0.1

  - cmd: ip link add mon0 type vxlan id 100 dstport 5555 remote 10.1.0.10
  - cmd: ip link set mon0 up
  - cmd: "tc qdisc add dev net1 root handle 10: prio"
  - cmd: "tc qdisc add dev net1 ingress"
  - cmd: "tc filter add dev net1 parent 10: prio 10 protocol all u32 match u32 0 0 flowid 10:1 action mirred egress mirror dev mon0"
  - cmd: "tc filter add dev net1 parent ffff: prio 10 protocol all u32 match u32 0 0 flowid ffff:1 action mirred egress mirror dev mon0"

- name: R3
  cmds:
  - cmd: ip addr add 10.3.0.3/24 dev net0
  - cmd: ip route add default via 10.3.0.2
